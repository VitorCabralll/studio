rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // REGRAS ULTRA-SIMPLES - SISTEMA NOVO SEM ERROS
    // ============================================================================
    
    // 1. USUÁRIOS - Cada usuário acessa apenas seu próprio perfil
    match /usuarios/{userId} {
      allow read, write, create: if request.auth != null && request.auth.uid == userId;
    }
    
    // 2. WORKSPACES - Apenas membros podem acessar (simplificado)
    match /workspaces/{workspaceId} {
      allow read, write, create: if request.auth != null;
    }
    
    // 3. AGENTES - Subcoleção livre para usuários autenticados
    match /workspaces/{workspaceId}/agentes/{document=**} {
      allow read, write, create: if request.auth != null;
    }
    
    // 4. DOCUMENTOS - Apenas do próprio usuário
    match /documentos/{documentId} {
      allow read, write, create: if request.auth != null;
    }
    
    // 5. UPLOADS - Apenas do próprio usuário  
    match /uploads/{uploadId} {
      allow read, write, create: if request.auth != null;
    }
    
    // 6. PROCESSAMENTO - Apenas do próprio usuário
    match /document_processing/{documentId} {
      allow read, write, create: if request.auth != null;
    }
    
    // 7. CONFIGURAÇÕES - Leitura livre
    match /configuracoes/{configId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas admin
    }
    
    // Fallback: NEGAR tudo que não foi explicitamente permitido
  }
}