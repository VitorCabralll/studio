rules_version = '2';

service cloud.firestore {
  match /databases/lexai/documents {
    // Usuários podem acessar apenas seus próprios dados (dev/prod namespaces)
    match /usuarios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Namespace para ambiente de produção
    match /prod_usuarios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Namespace para ambiente de desenvolvimento  
    match /dev_usuarios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Workspaces - apenas membros podem acessar (todos os namespaces)
    match /{namespace=**}/workspaces/{workspaceId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.members;
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.owners;
      allow list: if request.auth != null;
      allow get: if request.auth != null;
    }
    
    // Workspaces sem namespace
    match /workspaces/{workspaceId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.members;
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.owners;
      allow list: if request.auth != null;
      allow get: if request.auth != null;
    }
    
    // Agentes - apenas do workspace do usuário
    match /workspaces/{workspaceId}/agentes/{agentId} {
      allow read, write: if request.auth != null && 
        exists(/databases/lexai/documents/workspaces/$(workspaceId)) &&
        request.auth.uid in get(/databases/lexai/documents/workspaces/$(workspaceId)).data.members;
      allow create: if request.auth != null && 
        exists(/databases/lexai/documents/workspaces/$(workspaceId)) &&
        request.auth.uid in get(/databases/lexai/documents/workspaces/$(workspaceId)).data.members;
    }
    
    // Permitir listagem de agentes para membros do workspace
    match /workspaces/{workspaceId}/agentes {
      allow read: if request.auth != null && 
        exists(/databases/lexai/documents/workspaces/$(workspaceId)) &&
        request.auth.uid in get(/databases/lexai/documents/workspaces/$(workspaceId)).data.members;
    }
    
    // Documentos gerados - apenas do usuário
    match /documentos/{documentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
    
    // Uploads/anexos - apenas do usuário
    match /uploads/{uploadId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
    
    // Configurações globais - apenas leitura para usuários autenticados
    match /configuracoes/{configId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas admins via functions
    }
    
    // Documentos finais - apenas do usuário
    match /documents/{documentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Processamento de documentos - apenas do usuário
    match /document_processing/{documentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Retenção de dados - apenas do usuário
    match /data_retention/{documentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
  }
}