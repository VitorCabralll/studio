rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Função helper para verificar se é documento de staging
    function isStagingDocument() {
      return resource != null && 
        ('staging_' in resource.data.keys() || 
         resource.id.matches('staging_.*'));
    }
    
    // Função helper para verificar staging namespace
    function hasValidStagingNamespace(data) {
      return 'staging_' in data.keys() && data.staging_ == true;
    }
    
    // === DADOS DE STAGING COM NAMESPACE ===
    
    // Usuários staging
    match /staging_usuarios/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Validar que novos documentos têm flag de staging
      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        hasValidStagingNamespace(request.resource.data);
    }
    
    // Workspaces staging
    match /staging_workspaces/{workspaceId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.members &&
        isStagingDocument();
      
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.owners &&
        hasValidStagingNamespace(request.resource.data);
    }
    
    // Agentes staging
    match /staging_workspaces/{workspaceId}/agentes/{agentId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/staging_workspaces/$(workspaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/staging_workspaces/$(workspaceId)).data.members;
    }
    
    // Documentos staging
    match /staging_documentos/{documentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        isStagingDocument();
        
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        hasValidStagingNamespace(request.resource.data);
    }
    
    // Uploads staging
    match /staging_uploads/{uploadId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        isStagingDocument();
        
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        hasValidStagingNamespace(request.resource.data);
    }
    
    // === DADOS DE PRODUÇÃO (PROTEGIDOS) ===
    
    // Usuários produção
    match /usuarios/{userId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == userId &&
        !isStagingDocument();
    }
    
    // Workspaces produção
    match /workspaces/{workspaceId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.members &&
        !isStagingDocument();
      
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.owners &&
        !hasValidStagingNamespace(request.resource.data);
    }
    
    // Agentes produção
    match /workspaces/{workspaceId}/agentes/{agentId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/workspaces/$(workspaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.members &&
        !isStagingDocument();
    }
    
    // Documentos produção
    match /documentos/{documentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        !isStagingDocument();
    }
    
    // Uploads produção
    match /uploads/{uploadId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        !isStagingDocument();
    }
    
    // === CONFIGURAÇÕES COMPARTILHADAS ===
    
    // Configurações globais - apenas leitura
    match /configuracoes/{configId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas admins via functions
    }
    
    // Logs de staging (para debug)
    match /staging_logs/{logId} {
      allow read, write: if request.auth != null &&
        hasValidStagingNamespace(request.resource.data);
    }
  }
}